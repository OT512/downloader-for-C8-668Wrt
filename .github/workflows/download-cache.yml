name: Build Download Cache

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag name'
        required: true
        default: 'dl-cache-latest'

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y git wget curl xz-utils unzip

      - name: Checkout ImmortalWrt
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          git checkout 3a53d6c

      - name: Apply feeds.conf and update feeds
        run: |
          cp feeds.conf.default openwrt/feeds.conf.default
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply patch and copy files
        run: |
          cd openwrt
          git apply ../c8668.patch || true
          cp ../mt7981-nradio-common.dtsi     target/linux/mediatek/dts/
          cp ../mt7981-nradio-emmc-2nd.dtsi   target/linux/mediatek/dts/
          cp ../mt7981b-nradio-c8-668-2nd.dts target/linux/mediatek/dts/
          cp ../c8668.config .config

      - name: Download all packages
        run: |
          cd openwrt
          make download -j8 IGNORE_ERRORS=1 2>&1 | tee download.log || true
          grep -E "ERROR|Wrong hash|No more mirrors" download.log > download-errors.log || true

      - name: Package and release
        run: |
          echo "Files: $(ls openwrt/dl/ | wc -l), Size: $(du -sh openwrt/dl/ | cut -f1)"
          tar -czf dl-cache.tar.gz -C openwrt dl/
          ls -lh dl-cache.tar.gz

      - name: Upload error log
        uses: actions/upload-artifact@v4
        with:
          name: download-errors
          path: openwrt/download-errors.log
          if-no-files-found: ignore

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: "DL Cache ${{ github.event.inputs.release_tag }}"
          files: dl-cache.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
